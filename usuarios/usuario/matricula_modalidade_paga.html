{% extends 'publico/base.html' %}
{% load static %}

{% block title %}Matrícula por Modalidade - Dojô Uemura{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <div class="display-4 text-primary mb-3">
                            <i class="bi bi-award"></i>
                        </div>
                        <h2 class="fw-bold">Matrícula por Modalidade</h2>
                        <p class="text-muted">Escolha sua modalidade e faça sua inscrição</p>
                    </div>

                    <!-- Informações sobre modalidades pagas -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading fw-bold">
                            <i class="bi bi-info-circle me-2"></i>
                            Modalidades Disponíveis
                        </h6>
                        <p class="mb-0">
                            <strong>Judô, Muay Thai, Boxe e Capoeira</strong><br>
                            Para crianças a partir de 6 anos e adultos
                        </p>
                    </div>

                    <!-- Busca por CPF Existente (FORMULÁRIO SEPARADO) -->
                    <form method="post" id="buscaCpfForm" class="mb-4">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary border-bottom pb-2 mb-3">
                                    <i class="bi bi-search me-2"></i>
                                    Buscar Atleta Existente
                                </h5>
                                <div class="alert alert-info">
                                    <strong>Dica:</strong> Se o atleta já está cadastrado no projeto social, 
                                    busque pelo CPF para reutilizar os dados e escolher apenas a nova modalidade.
                                </div>
                            </div>
                            
                            <div class="col-md-8 mb-3">
                                <label for="cpf_busca" class="form-label fw-bold">CPF do Atleta</label>
                                <input type="text" class="form-control" id="cpf_busca" name="cpf_busca" 
                                       placeholder="000.000.000-00" value="{% if atleta_existente %}{{ atleta_existente.cpf }}{% endif %}">
                                <small class="text-muted">Digite o CPF para buscar atleta existente</small>
                            </div>
                            
                            <div class="col-md-4 mb-3 d-flex align-items-end">
                                <button type="submit" name="buscar_cpf" class="btn btn-info w-100">
                                    <i class="bi bi-search me-2"></i>
                                    Buscar Atleta
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Mensagens de Status -->
                    {% if success_message %}
                    <div class="alert alert-success mb-4">
                        <h6 class="alert-heading fw-bold">
                            <i class="bi bi-check-circle me-2"></i>
                            Atleta Encontrado!
                        </h6>
                        <p class="mb-0">{{ success_message }}</p>
                    </div>
                    {% endif %}
                    
                    {% if error_message %}
                    <div class="alert alert-danger mb-4">
                        <h6 class="alert-heading fw-bold">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Erro na Busca
                        </h6>
                        <p class="mb-0">{{ error_message }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- Formulário de Matrícula -->
                    <form method="post" enctype="multipart/form-data" id="matriculaModalidadePagaForm">
                        {% csrf_token %}
                        
                        <!-- Dados do Atleta -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary border-bottom pb-2 mb-3">
                                    <i class="bi bi-person-plus me-2"></i>
                                    Dados do Atleta
                                </h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="nome" class="form-label fw-bold">
                                    <i class="bi bi-person me-1"></i>
                                    Nome Completo *
                                </label>
                                <input type="text" class="form-control" id="nome" name="nome" 
                                       value="{% if atleta_existente %}{{ atleta_existente.nome }}{% endif %}" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="data_nascimento" class="form-label fw-bold">
                                    <i class="bi bi-calendar me-1"></i>
                                    Data de Nascimento *
                                </label>
                                <input type="date" class="form-control" id="data_nascimento" name="data_nascimento" 
                                       value="{% if atleta_existente %}{{ atleta_existente.data_nascimento|date:'Y-m-d' }}{% endif %}" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="cpf" class="form-label fw-bold">
                                    <i class="bi bi-card-text me-1"></i>
                                    CPF *
                                </label>
                                <input type="text" class="form-control" id="cpf" name="cpf" 
                                       value="{% if atleta_existente %}{{ atleta_existente.cpf }}{% endif %}" 
                                       placeholder="000.000.000-00" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="parentesco" class="form-label fw-bold">Parentesco</label>
                                <select class="form-control" id="parentesco" name="parentesco" required>
                                    <option value="">Selecione...</option>
                                    <option value="filho" {% if atleta_existente and atleta_existente.parentesco == 'filho' %}selected{% endif %}>Filho(a)</option>
                                    <option value="enteado" {% if atleta_existente and atleta_existente.parentesco == 'enteado' %}selected{% endif %}>Enteado(a)</option>
                                    <option value="neto" {% if atleta_existente and atleta_existente.parentesco == 'neto' %}selected{% endif %}>Neto(a)</option>
                                    <option value="sobrinho" {% if atleta_existente and atleta_existente.parentesco == 'sobrinho' %}selected{% endif %}>Sobrinho(a)</option>
                                    <option value="outro" {% if atleta_existente and atleta_existente.parentesco == 'outro' %}selected{% endif %}>Outro</option>
                                </select>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="foto" class="form-label fw-bold">
                                    <i class="bi bi-camera me-1"></i>
                                    Foto {% if not atleta_existente %}*{% endif %}
                                </label>
                                <input type="file" class="form-control" id="foto" name="foto" accept="image/*" {% if not atleta_existente %}required{% endif %}>
                                <div class="form-text">
                                    {% if atleta_existente %}
                                        Foto atualizada do atleta (opcional se já possui foto)
                                    {% else %}
                                        Foto atualizada do atleta
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dados Escolares (Opcionais para Modalidade Paga) -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary border-bottom pb-2 mb-3">
                                    <i class="bi bi-mortarboard me-2"></i>
                                    Dados Escolares (Opcionais)
                                </h5>
                                <div class="alert alert-info">
                                    <strong>Nota:</strong> Para matrícula em modalidade paga, os dados escolares são opcionais.
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="escolaridade" class="form-label fw-bold">Escolaridade</label>
                                <select class="form-control" id="escolaridade" name="escolaridade">
                                    <option value="">Selecione...</option>
                                    <option value="fundamental_1" {% if atleta_existente and atleta_existente.escolaridade == 'fundamental_1' %}selected{% endif %}>Ensino Fundamental I (1º ao 5º ano)</option>
                                    <option value="fundamental_2" {% if atleta_existente and atleta_existente.escolaridade == 'fundamental_2' %}selected{% endif %}>Ensino Fundamental II (6º ao 9º ano)</option>
                                    <option value="medio" {% if atleta_existente and atleta_existente.escolaridade == 'medio' %}selected{% endif %}>Ensino Médio</option>
                                    <option value="tecnico" {% if atleta_existente and atleta_existente.escolaridade == 'tecnico' %}selected{% endif %}>Ensino Técnico</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="escola" class="form-label fw-bold">Nome da Escola</label>
                                <input type="text" class="form-control" id="escola" name="escola" 
                                       value="{% if atleta_existente %}{{ atleta_existente.escola }}{% endif %}" 
                                       placeholder="Nome da escola (opcional)">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="turno" class="form-label fw-bold">Turno</label>
                                <select class="form-control" id="turno" name="turno">
                                    <option value="">Selecione...</option>
                                    <option value="matutino" {% if atleta_existente and atleta_existente.turno == 'matutino' %}selected{% endif %}>Matutino</option>
                                    <option value="vespertino" {% if atleta_existente and atleta_existente.turno == 'vespertino' %}selected{% endif %}>Vespertino</option>
                                    <option value="noturno" {% if atleta_existente and atleta_existente.turno == 'noturno' %}selected{% endif %}>Noturno</option>
                                    <option value="integral" {% if atleta_existente and atleta_existente.turno == 'integral' %}selected{% endif %}>Integral</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Endereço -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary border-bottom pb-2 mb-3">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    Endereço
                                </h5>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="cep" class="form-label fw-bold">CEP</label>
                                <input type="text" class="form-control" id="cep" name="cep" 
                                       value="{% if atleta_existente %}{{ atleta_existente.cep }}{% endif %}" 
                                       placeholder="00000-000" required>
                            </div>
                            
                            <div class="col-md-8 mb-3">
                                <label for="logradouro" class="form-label fw-bold">Logradouro</label>
                                <input type="text" class="form-control" id="logradouro" name="logradouro" 
                                       value="{% if atleta_existente %}{{ atleta_existente.logradouro }}{% endif %}" required>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="numero" class="form-label fw-bold">Número</label>
                                <input type="text" class="form-control" id="numero" name="numero" 
                                       value="{% if atleta_existente %}{{ atleta_existente.numero }}{% endif %}" required>
                            </div>
                            
                            <div class="col-md-8 mb-3">
                                <label for="complemento" class="form-label fw-bold">Complemento</label>
                                <input type="text" class="form-control" id="complemento" name="complemento" 
                                       value="{% if atleta_existente %}{{ atleta_existente.complemento }}{% endif %}" 
                                       placeholder="Apartamento, bloco, etc. (opcional)">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="bairro" class="form-label fw-bold">Bairro</label>
                                <input type="text" class="form-control" id="bairro" name="bairro" 
                                       value="{% if atleta_existente %}{{ atleta_existente.bairro }}{% endif %}" required>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="cidade" class="form-label fw-bold">Cidade</label>
                                <input type="text" class="form-control" id="cidade" name="cidade" 
                                       value="{% if atleta_existente %}{{ atleta_existente.cidade }}{% endif %}" required>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="uf" class="form-label fw-bold">UF</label>
                                <input type="text" class="form-control" id="uf" name="uf" maxlength="2" 
                                       value="{% if atleta_existente %}{{ atleta_existente.uf }}{% endif %}" 
                                       placeholder="MT" required>
                            </div>
                        </div>
                        
                        <!-- Informações de Saúde -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary border-bottom pb-2 mb-3">
                                    <i class="bi bi-heart-pulse me-2"></i>
                                    Informações de Saúde
                                </h5>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="condicoes_medicas" class="form-label fw-bold">Condições Médicas</label>
                                <textarea class="form-control" id="condicoes_medicas" name="condicoes_medicas" rows="4" 
                                          placeholder="Descreva qualquer condição médica relevante para a prática de esportes (opcional)">{% if atleta_existente %}{{ atleta_existente.condicoes_medicas }}{% endif %}</textarea>
                            </div>
                        </div>
                        
                        <!-- Modalidade e Pagamento -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary border-bottom pb-2 mb-3">
                                    <i class="bi bi-credit-card me-2"></i>
                                    Modalidade e Pagamento
                                </h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="modalidade" class="form-label fw-bold">Modalidade *</label>
                                <select class="form-control" id="modalidade" name="modalidade" required>
                                    <option value="">Selecione a modalidade...</option>
                                    {% for modalidade in modalidades %}
                                    <option value="{{ modalidade.id }}">{{ modalidade.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Termos e Condições -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary border-bottom pb-2 mb-3">
                                    <i class="bi bi-file-check me-2"></i>
                                    Termos e Condições
                                </h5>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="termo_responsabilidade" name="termo_responsabilidade" required>
                                    <label class="form-check-label" for="termo_responsabilidade">
                                        <strong>Declaro que sou responsável pelo atleta</strong> e autorizo sua participação nas atividades da modalidade escolhida.
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="termo_uso_imagem" name="termo_uso_imagem" required>
                                    <label class="form-check-label" for="termo_uso_imagem">
                                        <strong>Autorizo o uso de imagem</strong> do atleta para fins promocionais e educacionais.
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informações de Pagamento -->
                        <div class="alert alert-warning mb-4">
                            <h6 class="alert-heading fw-bold">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Pagamento da Mensalidade
                            </h6>
                            <p class="mb-0">
                                <strong>Valor:</strong> Será informado conforme a modalidade escolhida<br>
                                <strong>Forma de Pagamento:</strong> Será informada após aprovação da matrícula
                            </p>
                        </div>
                        
                        <!-- Botões -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'home' %}" class="btn btn-secondary me-md-2">
                                <i class="bi bi-arrow-left me-2"></i>
                                Voltar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>
                                Solicitar Matrícula
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para validações -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('matriculaModalidadePagaForm');
    const dataNascimento = document.getElementById('data_nascimento');
    const cpf = document.getElementById('cpf');
    const cepInput = document.getElementById('cep');
    const logradouroInput = document.getElementById('logradouro');
    const bairroInput = document.getElementById('bairro');
    const cidadeInput = document.getElementById('cidade');
    const ufInput = document.getElementById('uf');
    
    // Validação de idade mínima (6 anos)
    dataNascimento.addEventListener('change', function() {
        const hoje = new Date();
        const nascimento = new Date(this.value);
        const idade = hoje.getFullYear() - nascimento.getFullYear();
        const mes = hoje.getMonth() - nascimento.getMonth();
        
        if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
            idade--;
        }
        
        if (idade < 6) {
            alert('O atleta deve ter pelo menos 6 anos para se matricular.');
            this.value = '';
        }
    });
    
    // Máscara para CPF
    cpf.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        this.value = value;
    });
    
    // Máscara para CEP
    cepInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        value = value.replace(/(\d{5})(\d)/, '$1-$2');
        this.value = value;
    });
    
    // Autocompletar endereço quando CEP for digitado
    cepInput.addEventListener('blur', function() {
        const cep = this.value.replace(/\D/g, '');
        
        if (cep.length === 8) {
            // Mostrar indicador de carregamento
            this.classList.add('is-loading');
            
            // Fazer requisição para a API ViaCEP
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        // Preencher campos automaticamente
                        logradouroInput.value = data.logradouro || '';
                        bairroInput.value = data.bairro || '';
                        cidadeInput.value = data.localidade || '';
                        ufInput.value = data.uf || '';
                        
                        // Adicionar classe de sucesso
                        this.classList.add('is-valid');
                        this.classList.remove('is-invalid');
                        
                        // Focar no campo número
                        document.getElementById('numero').focus();
                    } else {
                        // CEP não encontrado
                        this.classList.add('is-invalid');
                        this.classList.remove('is-valid');
                        alert('CEP não encontrado. Verifique e tente novamente.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar CEP:', error);
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                    alert('Erro ao buscar CEP. Tente novamente.');
                })
                .finally(() => {
                    this.classList.remove('is-loading');
                });
        }
    });
    
    // Validação do formulário
    form.addEventListener('submit', function(e) {
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Por favor, preencha todos os campos obrigatórios.');
        }
    });
});
</script>
{% endblock %}
